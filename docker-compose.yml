version: '3.8'

services:
  # 1. Nginx Gateway (Load Balancer & SSL Termination)
  nginx:
    image: nginx:alpine
    container_name: umt_nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    depends_on:
      - frontend
      - backend-1
      - backend-2
      - backend-3
    networks:
      - vdi_net

  # Service Certbot (Tự động gia hạn SSL)
  certbot:
    image: certbot/certbot
    container_name: umt_certbot
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot

  postgres: # Tên service
    image: postgres:15-alpine
    container_name: umt_db # Tên container (khớp với DB_HOST trong .env)
    restart: always
    env_file: .env
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    networks:
      - vdi_net

  # 3. Backend Cluster (3 Nodes)
  
  # --- Backend 1 -> Worker 1 (101.47.159.90) ---
  backend-1:
    build: ./backend
    container_name: umt_backend_1
    restart: always
    env_file: .env
    environment:
      - DB_HOST=${DB_HOST}         # Lấy umt_db từ .env
      - DB_PORT=${DB_PORT}         # Lấy 5432 từ .env
      - DB_USERNAME=${DB_USER}     # Lấy umt_user từ .env
      - DB_PASSWORD=${DB_PASSWORD} # Lấy 7816404122SOT từ .env
      - DB_DATABASE=${DB_NAME}     # Lấy vdi_portal_db từ .env
      - GUAC_CRYPT_KEY=${GUAC_CRYPT_KEY}
      - BACKEND_NODE_INDEX=0
      - GUACD_HOST=101.47.159.90   # Worker 1
    depends_on:
      - postgres
    networks:
      - vdi_net

  # --- Backend 2 -> Worker 2 (101.47.159.85) ---
  backend-2:
    build: ./backend
    container_name: umt_backend_2
    restart: always
    env_file: .env
    environment:
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_USERNAME=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_DATABASE=${DB_NAME}
      - GUAC_CRYPT_KEY=${GUAC_CRYPT_KEY}
      - BACKEND_NODE_INDEX=1
      - GUACD_HOST=101.47.159.85   # Worker 2
    depends_on:
      - postgres
    networks:
      - vdi_net

  # --- Backend 3 -> Worker 3 (101.47.159.88) ---
  backend-3:
    build: ./backend
    container_name: umt_backend_3
    restart: always
    env_file: .env
    environment:
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_USERNAME=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_DATABASE=${DB_NAME}
      - GUAC_CRYPT_KEY=${GUAC_CRYPT_KEY}
      - BACKEND_NODE_INDEX=2
      - GUACD_HOST=101.47.159.88   # Worker 3
    depends_on:
      - postgres
    networks:
      - vdi_net

  # 4. Frontend Client
  frontend:
    build: ./frontend
    container_name: umt_frontend
    restart: always
    env_file: .env
    networks:
      - vdi_net

# --- CẤU HÌNH MẠNG ---
networks:
  vdi_net:
    driver: bridge
    driver_opts:
      com.docker.network.driver.mtu: "1350"
